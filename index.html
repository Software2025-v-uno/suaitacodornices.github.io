<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4CAF50">
<title>El Portachuelo | Registro de Ventas y Gastos</title>
<link rel="icon" href="img/logo.png">
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>window.jsPDF = window.jspdf.jsPDF;</script>
<style>
:root {
--primary: #4CAF50;
--secondary: #388E3C;
--light-green: #81C784;
--dark-green: #2E7D32;
--expense-color: #FF9800;
--expense-bg: #FFF3E0;
--white: #FFFFFF;
--gray: #616161;
--light-bg: #e8f5e9;
--medium-bg: #c8e6c9;
--dark-bg: #a5d6a7;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
-webkit-tap-highlight-color: transparent;
}

body {
background: linear-gradient(135deg, var(--light-bg) 0%, var(--medium-bg) 50%, var(--dark-bg) 100%);
min-height: 100vh;
padding: 12px;
color: #333;
transition: all 0.3s ease;
}

.container {
max-width: 1200px;
margin: 0 auto;
}

/* PIN Authentication */
.page-loader {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: linear-gradient(135deg, var(--light-bg) 0%, var(--medium-bg) 50%, var(--dark-bg) 100%);
display: flex;
justify-content: center;
align-items: center;
z-index: 9999;
opacity: 1;
visibility: visible;
transition: opacity 0.5s ease;
}

.pin-container {
text-align: center;
background: white;
padding: 24px 16px;
border-radius: 16px;
box-shadow: 0 12px 30px rgba(0,0,0,0.15);
width: 94%;
max-width: 400px;
position: relative;
overflow: hidden;
animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
margin: 0 8px;
}

.pin-container::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 4px;
background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
}

.pin-logo {
width: 80px;
height: 80px;
background: url('img/codorniz.jpg');
background-size: contain;
background-position: center;
background-repeat: no-repeat;
border-radius: 50%;
margin: 0 auto 20px;
animation: pulse 2s infinite;
}

.pin-title {
font-size: 1.8rem;
color: var(--dark-green);
margin-bottom: 8px;
font-weight: 700;
}

.pin-subtitle {
color: var(--gray);
margin-bottom: 20px;
font-size: 1rem;
}

.pin-input {
width: 100%;
padding: 14px 16px;
border: 2px solid var(--light-green);
border-radius: 10px;
font-size: 1.8rem;
text-align: center;
margin-bottom: 20px;
background: white;
font-weight: bold;
transition: all 0.3s ease;
-webkit-text-security: disc;
text-security: disc;
caret-color: transparent;
}

.pin-pad {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 10px;
margin-bottom: 16px;
}

.pin-btn {
width: 100%;
height: 52px;
background: white;
border: 1.5px solid var(--light-green);
border-radius: 10px;
color: var(--dark-green);
font-size: 1.4rem;
font-weight: bold;
cursor: pointer;
transition: all 0.15s ease;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
touch-action: manipulation;
}

.pin-btn:hover, .pin-btn:active {
transform: scale(0.98);
}

.pin-btn.clear, .pin-btn.enter {
background: var(--primary);
color: white;
font-size: 1.2rem;
}

/* Main Layout */
header {
text-align: center;
margin-bottom: 20px;
padding: 16px;
background: rgba(255, 255, 255, 0.95);
border-radius: 14px;
box-shadow: 0 6px 16px rgba(0,0,0,0.08);
position: relative;
overflow: hidden;
}

.logo-container {
display: flex;
justify-content: center;
align-items: center;
margin-bottom: 12px;
gap: 12px;
flex-wrap: wrap;
}

.logo {
width: 90px;
height: 90px;
background: url('img/codorniz.jpg');
background-size: contain;
background-position: center;
background-repeat: no-repeat;
border-radius: 50%;
}

h1 {
color: var(--dark-green);
font-size: 1.8rem;
margin-bottom: 6px;
font-weight: 700;
}

.subtitle {
color: var(--gray);
font-size: 1rem;
margin-bottom: 10px;
}

/* Responsive Dashboard */
.dashboard {
display: flex;
flex-direction: column;
gap: 16px;
margin-bottom: 20px;
}

@media (min-width: 768px) {
.dashboard {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}
}

.card {
background: rgba(255, 255, 255, 0.95);
border-radius: 14px;
padding: 18px;
box-shadow: 0 6px 16px rgba(0,0,0,0.08);
transition: transform 0.2s ease;
position: relative;
overflow: hidden;
}

.card::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 4px;
height: 100%;
background: linear-gradient(to bottom, var(--primary), var(--secondary));
}

.card:hover {
transform: translateY(-3px);
}

.card-title {
font-size: 1.4rem;
color: var(--dark-green);
margin-bottom: 16px;
padding-bottom: 10px;
display: flex;
align-items: center;
gap: 10px;
font-weight: 700;
}

.card-title::after {
content: '';
flex: 1;
height: 1.5px;
background: linear-gradient(to right, var(--light-green), transparent);
margin-left: 10px;
}

.expense-card::before {
background: linear-gradient(to bottom, var(--expense-color), #E65100);
}

.expense-card .card-title {
color: #E65100;
}

.expense-card .card-title::after {
background: linear-gradient(to right, #FFB74D, transparent);
}

.form-group {
margin-bottom: 16px;
}

label {
display: block;
margin-bottom: 6px;
font-weight: 600;
color: var(--dark-green);
font-size: 0.95rem;
}

.expense-card label {
color: #E65100;
}

input, select, textarea {
width: 100%;
padding: 12px;
border: 1.5px solid var(--light-green);
border-radius: 10px;
font-size: 1rem;
transition: all 0.3s ease;
background-color: white;
}

.expense-card input, .expense-card select, .expense-card textarea {
border-color: #FFB74D;
}

input:focus, select:focus, textarea:focus {
outline: none;
border-color: var(--secondary);
box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.2);
}

.expense-card input:focus, .expense-card select:focus, .expense-card textarea:focus {
border-color: #E65100;
box-shadow: 0 0 0 3px rgba(230, 81, 0, 0.2);
}

.btn {
display: block;
width: 100%;
padding: 14px;
background: var(--primary);
color: white;
border: none;
border-radius: 10px;
font-size: 1.1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
text-align: center;
box-shadow: 0 3px 6px rgba(76, 175, 80, 0.3);
touch-action: manipulation;
}

.btn:hover {
background: var(--secondary);
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(56, 142, 60, 0.4);
}

.btn-success {
background: linear-gradient(45deg, var(--dark-green), #1B5E20);
}

.btn-expense {
background: linear-gradient(45deg, #FF9800, #E65100);
}

.btn-expense:hover {
background: linear-gradient(45deg, #E65100, #BF360C);
}

/* Resumen */
.results {
background: linear-gradient(135deg, var(--primary), var(--secondary));
color: white;
border-radius: 14px;
padding: 18px;
}

.expense-summary {
background: linear-gradient(135deg, #FF9800, #E65100);
color: white;
border-radius: 14px;
padding: 18px;
margin-top: 16px;
}

.result-item {
display: flex;
justify-content: space-between;
padding: 10px 0;
border-bottom: 1px solid rgba(255,255,255,0.2);
}

.result-item:last-child {
border-bottom: none;
}

.result-label {
font-size: 0.95rem;
font-weight: 600;
}

.result-value {
font-size: 1.3rem;
font-weight: 700;
}

.total {
font-size: 1.6rem !important;
color: #FFD700;
}

.neto-positivo { color: #4CAF50 !important; }
.neto-negativo { color: #F44336 !important; }

/* Tablas */
.table-container {
overflow-x: auto;
border-radius: 10px;
margin: 16px 0;
}

.sales-table, .expenses-table {
width: 100%;
border-collapse: collapse;
min-width: 600px;
}

.sales-table th, .expenses-table th {
background: var(--light-green);
color: var(--dark-green);
text-align: left;
padding: 12px 14px;
font-weight: 600;
font-size: 0.85rem;
}

.expenses-table th {
background: #FFB74D;
color: #E65100;
}

.sales-table td, .expenses-table td {
padding: 12px 14px;
font-size: 0.9rem;
border-bottom: 1px solid var(--light-green);
}

.expenses-table td {
border-bottom: 1px solid #FFE0B2;
}

.actions {
display: flex;
gap: 6px;
}

.action-btn {
padding: 6px 12px;
border-radius: 6px;
font-size: 0.75rem;
cursor: pointer;
border: none;
font-weight: 600;
}

.edit-btn {
background: var(--light-green);
color: var(--dark-green);
}

.delete-btn {
background: #EF5350;
color: white;
}

/* Footer */
.footer {
text-align: center;
margin-top: 20px;
padding: 16px;
color: var(--gray);
font-size: 0.85rem;
border-top: 1px solid rgba(0,0,0,0.05);
}

/* Deudas */
.debt-section {
margin-top: 16px;
padding: 16px;
background: rgba(255, 243, 224, 0.5);
border-radius: 10px;
border-left: 3px solid #FF9800;
}

.debt-title {
color: #E65100;
font-weight: 600;
margin-bottom: 12px;
font-size: 1rem;
}

.debt-options {
display: grid;
grid-template-columns: 1fr;
gap: 12px;
}

@media (min-width: 600px) {
.debt-options {
grid-template-columns: 1fr 1fr;
}
}

/* PDF Template (oculto) */
.pdf-template {
display: none;
width: 100%;
max-width: 800px;
margin: 0 auto;
background: white;
padding: 40px;
font-family: 'Arial', sans-serif;
box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.pdf-header {
text-align: center;
margin-bottom: 30px;
border-bottom: 3px solid var(--primary);
padding-bottom: 20px;
}

.pdf-logo {
width: 120px;
height: 120px;
background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cGF0aCBkPSJNMTAwIDUwQzYwIDUwIDQwIDgwIDQwIDEwMEM0MCAxMjAgNjAgMTUwIDEwMCAxNTBDMTQwIDE1MCAxNjAgMTIwIDE2MCAxMDBDMTYwIDgwIDE0MCA1MCAxMDAgNTB6IiBmaWxsPSIjNENBRjUwIi8+PHBhdGggZD0iTTEwMCA1MEM2MCA1MCA0MCA4MCA0MCAxMDBDMTQwIDEwMCAxNjAgODAgMTAwIDUweiIgZmlsbD0iIzNDOEUzQiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzNDOEUzQiIgc3Ryb2tlLXdpZHRoPSIyIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSIzNSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNENBRjUwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=');
background-size: contain;
background-position: center;
background-repeat: no-repeat;
margin: 0 auto 15px;
}

.pdf-title {
font-size: 28px;
color: var(--dark-green);
margin-bottom: 10px;
font-weight: bold;
}

.pdf-subtitle {
color: var(--gray);
font-size: 18px;
}

.pdf-info {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin: 30px 0;
}

.info-item {
margin-bottom: 15px;
}

.info-label {
font-weight: bold;
color: var(--dark-green);
}

.info-value {
color: var(--gray);
}

.pdf-table {
width: 100%;
border-collapse: collapse;
margin: 30px 0;
}

.pdf-table th {
background: var(--primary);
color: white;
text-align: left;
padding: 12px;
font-weight: bold;
}

.pdf-table.expense-table th {
background: #FF9800;
}

.pdf-table td {
padding: 12px;
border: 1px solid var(--light-green);
color: var(--gray);
}

.pdf-total {
text-align: right;
font-size: 20px;
font-weight: bold;
margin-top: 20px;
color: var(--primary);
}

.pdf-neto {
text-align: right;
font-size: 22px;
font-weight: bold;
margin-top: 15px;
}

/* Animations */
@keyframes slideIn {
from { transform: translateY(-20px) scale(0.95); opacity: 0; }
to { transform: translateY(0) scale(1); opacity: 1; }
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.03); }
100% { transform: scale(1); }
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

/* Badge de conexi√≥n */
.connection-status {
position: fixed;
top: 10px;
right: 10px;
padding: 6px 12px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: bold;
color: white;
z-index: 1000;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.online { background: #4CAF50; }
.offline { background: #F44336; }
.syncing { background: #2196F3; animation: pulse 1.5s infinite; }
</style>
</head>
<body>
<!-- Connection Status Badge -->
<div class="connection-status online" id="connection-badge">En l√≠nea</div>

<!-- PIN Authentication -->
<div class="page-loader" id="pin-screen">
<div class="pin-container">
<div class="pin-logo"></div>
<h2 class="pin-title">El Portachuelo</h2>
<p class="pin-subtitle">Ingrese su PIN para acceder</p>
<input type="password" id="pin-input" class="pin-input" maxlength="4" placeholder="" autocomplete="off">
<div class="pin-pad">
<button class="pin-btn" data-value="1">1</button>
<button class="pin-btn" data-value="2">2</button>
<button class="pin-btn" data-value="3">3</button>
<button class="pin-btn" data-value="4">4</button>
<button class="pin-btn" data-value="5">5</button>
<button class="pin-btn" data-value="6">6</button>
<button class="pin-btn" data-value="7">7</button>
<button class="pin-btn" data-value="8">8</button>
<button class="pin-btn" data-value="9">9</button>
<button class="pin-btn clear" data-action="clear">C</button>
<button class="pin-btn" data-value="0">0</button>
<button class="pin-btn enter" data-action="enter">‚úì</button>
</div>
<p style="color: #666; font-size: 0.85rem; margin-top: 12px;"><strong style="color: var(--primary);"></strong></p>
</div>
</div>

<!-- Main Content -->
<div class="container" id="main-content" style="display: none; opacity: 0;">
<header>
<div class="logo-container">
<div class="logo"></div>
<div>
<h1>El Portachuelo</h1>
<p class="subtitle">Registro de Ventas y Gastos</p>
</div>
</div>
</header>

<div class="dashboard">
<div class="card">
<h2 class="card-title">üìù Nueva Venta</h2>
<div class="form-group">
<label for="cliente">Cliente</label>
<input type="text" id="cliente" placeholder="Nombre del cliente">
</div>
<div class="form-group">
<label for="cubetas">Cubetas</label>
<input type="number" id="cubetas" min="1" value="1">
</div>
<div class="form-group">
<label for="precio">Precio por cubeta ($)</label>
<input type="number" id="precio" min="1" value="5000">
</div>
<div class="form-group">
<label for="fecha-venta">Fecha y Hora</label>
<input type="datetime-local" id="fecha-venta">
</div>
<div class="debt-section">
<h3 class="debt-title">üí∞ Cr√©dito (opcional)</h3>
<div class="debt-options">
<div class="form-group">
<label for="cubetas-debe">Cubetas a cr√©dito</label>
<input type="number" id="cubetas-debe" min="0" value="0">
</div>
<div class="form-group">
<label for="monto-debe">Monto a cr√©dito ($)</label>
<input type="number" id="monto-debe" min="0" value="0">
</div>
</div>
</div>
<button class="btn" id="agregar-venta">‚ûï Agregar Venta</button>
</div>

<div class="card expense-card">
<h2 class="card-title">üì¶ Nuevo Gasto</h2>
<div class="form-group">
<label for="tipo-gasto">Tipo</label>
<select id="tipo-gasto">
<option value="purina">Bulto de Purina</option>
<option value="medicamento">Medicamentos</option>
<option value="transporte">Transporte</option>
<option value="mantenimiento">Mantenimiento</option>
<option value="otros">Otros</option>
</select>
</div>
<div class="form-group">
<label for="descripcion-gasto">Descripci√≥n</label>
<textarea id="descripcion-gasto" rows="2" placeholder="Detalles"></textarea>
</div>
<div class="form-group">
<label for="monto-gasto">Monto ($)</label>
<input type="number" id="monto-gasto" min="1" value="50000">
</div>
<div class="form-group">
<label for="fecha-gasto">Fecha y Hora</label>
<input type="datetime-local" id="fecha-gasto">
</div>
<button class="btn btn-expense" id="agregar-gasto">‚ûï Registrar Gasto</button>
</div>

<div class="card">
<h2 class="card-title">üìä Resumen Financiero</h2>
<div class="results">
<div class="result-item">
<span class="result-label">Ventas</span>
<span class="result-value" id="total-ventas">0</span>
</div>
<div class="result-item">
<span class="result-label">Ingresos ($)</span>
<span class="result-value total" id="total-ingresos">0</span>
</div>
<div class="result-item">
<span class="result-label">Cr√©ditos</span>
<span class="result-value" id="total-debe" style="color: #FF9800;">0</span>
</div>
</div>
<div class="expense-summary">
<div class="result-item">
<span class="result-label">Gastos</span>
<span class="result-value" id="total-gastos-count">0</span>
</div>
<div class="result-item">
<span class="result-label">Total Gastos ($)</span>
<span class="result-value total" id="total-gastos">0</span>
</div>
<div class="result-item">
<span class="result-label">Balance Neto ($)</span>
<span class="result-value total neto-positivo" id="balance-neto">0</span>
</div>
</div>
<button class="btn" id="generar-pdf" style="margin-top: 16px;">üìÑ Generar Reporte PDF</button>
</div>
</div>

<div class="card">
<h2 class="card-title">üìã Ventas (M√°s antigua ‚Üí Reciente)</h2>
<div class="table-container">
<table class="sales-table">
<thead>
<tr>
<th>Cliente</th>
<th>Cubetas</th>
<th>Precio</th>
<th>Total</th>
<th>Debe</th>
<th>Fecha y Hora</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="ventas-lista">
<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--gray)">Sin ventas</td></tr>
</tbody>
</table>
</div>
</div>

<div class="card">
<h2 class="card-title expense-card">üßæ Gastos (M√°s antiguo ‚Üí Reciente)</h2>
<div class="table-container">
<table class="expenses-table">
<thead>
<tr>
<th>Tipo</th>
<th>Descripci√≥n</th>
<th>Monto</th>
<th>Fecha y Hora</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="gastos-lista">
<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--gray)">Sin gastos</td></tr>
</tbody>
</table>
</div>
</div>

<div class="footer">
<p>El Portachuelo &copy; 2025 | Sistema Integral</p>
<p style="margin-top:4px;font-size:0.8rem">Calidad Premium ‚Ä¢ Frescura Garantizada</p>
</div>
</div>

<!-- PDF Template -->
<div id="pdf-template" class="pdf-template">
<div class="pdf-header">
<div class="pdf-logo"></div>
<h2 class="pdf-title">Reporte Financiero Completo</h2>
<p class="pdf-subtitle">El Portachuelo - Ventas y Gastos</p>
</div>
<div class="pdf-info">
<div>
<div class="info-item"><span class="info-label">Fecha del Reporte:</span><span class="info-value" id="pdf-report-date">-</span></div>
<div class="info-item"><span class="info-label">Total Ventas:</span><span class="info-value" id="pdf-ventas-count">-</span></div>
<div class="info-item"><span class="info-label">Total Gastos:</span><span class="info-value" id="pdf-gastos-count">-</span></div>
</div>
<div>
<div class="info-item"><span class="info-label">Total Ingresos:</span><span class="info-value" id="pdf-ingresos">-</span></div>
<div class="info-item"><span class="info-label">Total Gastos:</span><span class="info-value" id="pdf-gastos">-</span></div>
<div class="info-item"><span class="info-label">Balance Neto:</span><span class="info-value" id="pdf-neto">-</span></div>
</div>
</div>
<h3 style="margin:25px 0 15px;color:var(--dark-green);font-size:18px;">Ventas Registradas</h3>
<table class="pdf-table">
<thead><tr><th>Cliente</th><th>Cubetas</th><th>P. Unitario</th><th>Total</th><th>Debe</th><th>Fecha y Hora</th></tr></thead>
<tbody id="pdf-sales-table"><tr><td colspan="6" style="text-align:center">No hay ventas</td></tr></tbody>
</table>
<h3 style="margin:25px 0 15px;color:#E65100;font-size:18px;">Gastos Registrados</h3>
<table class="pdf-table expense-table">
<thead><tr><th>Tipo</th><th>Descripci√≥n</th><th>Monto</th><th>Fecha y Hora</th></tr></thead>
<tbody id="pdf-expenses-table"><tr><td colspan="4" style="text-align:center">No hay gastos</td></tr></tbody>
</table>
<div class="pdf-total">TOTAL INGRESOS: <span id="pdf-total-ingresos">-</span></div>
<div class="pdf-total">TOTAL GASTOS: <span id="pdf-total-gastos" style="color:#FF9800">-</span></div>
<div class="pdf-neto">BALANCE NETO: <span id="pdf-balance-neto">-</span></div>
<div style="margin-top:40px;text-align:center">
<p style="color:var(--dark-green);font-weight:bold">¬°Gracias por su confianza!</p>
<p>Control total de su negocio av√≠cola</p>
<p style="margin-top:10px;font-size:14px;color:#666">Tel: 301 595 4676 | ventas@elportachuelo.com</p>
</div>
</div>

<!-- IndexedDB Helper -->
<script>
// IndexedDB Manager (sin dependencia externa)
class DBManager {
  constructor() {
    this.db = null;
    this.init();
  }

  init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('PortachueloDB', 1);
      
      req.onerror = () => reject(req.error);
      req.onsuccess = () => {
        this.db = req.result;
        resolve(this.db);
      };

      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('ventas')) {
          db.createObjectStore('ventas', { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains('gastos')) {
          db.createObjectStore('gastos', { keyPath: 'id' });
        }
      };
    });
  }

  async saveVenta(venta) {
    await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['ventas'], 'readwrite');
      const store = tx.objectStore('ventas');
      venta.fechaRegistro = new Date().toISOString();
      const req = store.put(venta);
      req.onsuccess = () => resolve(venta.id);
      req.onerror = () => reject(req.error);
    });
  }

  async saveGasto(gasto) {
    await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['gastos'], 'readwrite');
      const store = tx.objectStore('gastos');
      gasto.fechaRegistro = new Date().toISOString();
      const req = store.put(gasto);
      req.onsuccess = () => resolve(gasto.id);
      req.onerror = () => reject(req.error);
    });
  }

  async getAllVentas() {
    await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['ventas'], 'readonly');
      const store = tx.objectStore('ventas');
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async getAllGastos() {
    await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['gastos'], 'readonly');
      const store = tx.objectStore('gastos');
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async deleteVenta(id) {
    await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['ventas'], 'readwrite');
      const store = tx.objectStore('ventas');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  async deleteGasto(id) {
    await this.init();
    return new Promise((resolve, reject) => {
      const tx = this.db.transaction(['gastos'], 'readwrite');
      const store = tx.objectStore('gastos');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }
}

const db = new DBManager();
</script>

<script>
// === NEGOCIO ===
class BusinessManager {
constructor() {
  this.ventas = [];
  this.gastos = [];
  this.currentEditSale = undefined;
  this.currentEditExpense = undefined;
  this.init();
}

init() {
  this.loadData();
  this.setTodayDates();
}

setTodayDates() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
  document.getElementById('fecha-venta').value = local.toISOString().slice(0, 16);
  document.getElementById('fecha-gasto').value = local.toISOString().slice(0, 16);
}

formatDateTime(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString('es-CO', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }).replace(',', '');
}

sortChronological(arr) {
  return [...arr].sort((a, b) => new Date(a.fechaCompleta) - new Date(b.fechaCompleta));
}

async loadData() {
  try {
    this.ventas = await db.getAllVentas();
    this.gastos = await db.getAllGastos();
    this.updateSummary();
    this.renderAll();
  } catch (e) {
    console.error('Error cargando datos:', e);
  }
}

addSale(data) {
  db.saveVenta({
    id: Date.now() + '-' + Math.random().toString(36).substr(2, 5),
    cliente: data.cliente.trim(),
    cubetas: data.cubetas,
    precio: data.precio,
    total: data.total,
    debe: data.debe || 0,
    fechaCompleta: data.fechaCompleta
  }).then(() => {
    this.loadData();
    this.notify('Venta guardada ‚úîÔ∏è');
  }).catch(err => {
    console.error('Error guardando venta:', err);
    this.notify('Error al guardar venta', 'error');
  });
}

updateSale(index, data) {
  // Como usamos IndexedDB, actualizamos por ID
  const v = this.ventas[index];
  if (!v) return;
  db.saveVenta({
    ...v,
    cliente: data.cliente.trim(),
    cubetas: data.cubetas,
    precio: data.precio,
    total: data.total,
    debe: data.debe || 0,
    fechaCompleta: data.fechaCompleta
  }).then(() => {
    this.loadData();
    this.notify('Venta actualizada ‚úîÔ∏è');
  }).catch(err => {
    console.error('Error actualizando venta:', err);
    this.notify('Error al actualizar', 'error');
  });
}

deleteSale(index) {
  const v = this.ventas[index];
  if (!v) return;
  db.deleteVenta(v.id).then(() => {
    this.loadData();
    this.notify('Venta eliminada');
  }).catch(err => {
    console.error('Error eliminando venta:', err);
    this.notify('Error al eliminar', 'error');
  });
}

addExpense(data) {
  db.saveGasto({
    id: Date.now() + '-' + Math.random().toString(36).substr(2, 5),
    tipo: data.tipo,
    descripcion: data.descripcion.trim(),
    monto: data.monto,
    fechaCompleta: data.fechaCompleta
  }).then(() => {
    this.loadData();
    this.notify('Gasto guardado ‚úîÔ∏è', 'expense');
  }).catch(err => {
    console.error('Error guardando gasto:', err);
    this.notify('Error al guardar gasto', 'error');
  });
}

updateExpense(index, data) {
  const g = this.gastos[index];
  if (!g) return;
  db.saveGasto({
    ...g,
    tipo: data.tipo,
    descripcion: data.descripcion.trim(),
    monto: data.monto,
    fechaCompleta: data.fechaCompleta
  }).then(() => {
    this.loadData();
    this.notify('Gasto actualizado ‚úîÔ∏è', 'expense');
  }).catch(err => {
    console.error('Error actualizando gasto:', err);
    this.notify('Error al actualizar', 'error');
  });
}

deleteExpense(index) {
  const g = this.gastos[index];
  if (!g) return;
  db.deleteGasto(g.id).then(() => {
    this.loadData();
    this.notify('Gasto eliminado', 'expense');
  }).catch(err => {
    console.error('Error eliminando gasto:', err);
    this.notify('Error al eliminar', 'error');
  });
}

updateSummary() {
  const ingr = this.ventas.reduce((s, v) => s + v.total, 0);
  const gast = this.gastos.reduce((s, g) => s + g.monto, 0);
  const debe = this.ventas.reduce((s, v) => s + (v.debe || 0), 0);
  const neto = ingr - gast;
  const update = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };
  update('total-ventas', this.ventas.length);
  update('total-ingresos', ingr.toLocaleString('es-CO'));
  update('total-debe', debe.toLocaleString('es-CO'));
  update('total-gastos-count', this.gastos.length);
  update('total-gastos', gast.toLocaleString('es-CO'));
  update('balance-neto', neto.toLocaleString('es-CO'));
  const netoEl = document.getElementById('balance-neto');
  if (netoEl) netoEl.className = `result-value total ${neto >= 0 ? 'neto-positivo' : 'neto-negativo'}`;
}

renderSales() {
  const list = document.getElementById('ventas-lista');
  if (this.ventas.length === 0) {
    list.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--gray)">Sin ventas</td></tr>`;
    return;
  }
  const sorted = this.sortChronological(this.ventas);
  list.innerHTML = sorted.map((v, i) => `
  <tr>
  <td>${v.cliente}</td>
  <td>${v.cubetas}</td>
  <td>$${v.precio.toLocaleString('es-CO')}</td>
  <td>$${v.total.toLocaleString('es-CO')}</td>
  <td style="color:${v.debe > 0 ? '#FF9800' : '#4CAF50'}">$${(v.debe || 0).toLocaleString('es-CO')}</td>
  <td>${this.formatDateTime(v.fechaCompleta)}</td>
  <td class="actions">
  <button class="action-btn edit-btn" onclick="businessManager.editSale(${this.ventas.indexOf(v)})">‚úèÔ∏è</button>
  <button class="action-btn delete-btn" onclick="businessManager.deleteSale(${this.ventas.indexOf(v)})">üóëÔ∏è</button>
  </td>
  </tr>
  `).join('');
}

renderExpenses() {
  const list = document.getElementById('gastos-lista');
  if (this.gastos.length === 0) {
    list.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--gray)">Sin gastos</td></tr>`;
    return;
  }
  const sorted = this.sortChronological(this.gastos);
  const tipoLabels = { purina: 'Purina', medicamento: 'Medicamento', transporte: 'Transporte', mantenimiento: 'Mant.', otros: 'Otros' };
  list.innerHTML = sorted.map((g, i) => `
  <tr>
  <td>${tipoLabels[g.tipo] || g.tipo}</td>
  <td>${g.descripcion || '-'}</td>
  <td style="color:#E65100;font-weight:bold">$${g.monto.toLocaleString('es-CO')}</td>
  <td>${this.formatDateTime(g.fechaCompleta)}</td>
  <td class="actions">
  <button class="action-btn edit-btn" onclick="businessManager.editExpense(${this.gastos.indexOf(g)})">‚úèÔ∏è</button>
  <button class="action-btn delete-btn" onclick="businessManager.deleteExpense(${this.gastos.indexOf(g)})">üóëÔ∏è</button>
  </td>
  </tr>
  `).join('');
}

renderAll() {
  this.renderSales();
  this.renderExpenses();
  this.updateSummary();
}

editSale(index) {
  if (index < 0 || index >= this.ventas.length) return;
  const v = this.ventas[index];
  document.getElementById('cliente').value = v.cliente;
  document.getElementById('cubetas').value = v.cubetas;
  document.getElementById('precio').value = v.precio;
  document.getElementById('fecha-venta').value = new Date(v.fechaCompleta).toISOString().slice(0, 16);
  document.getElementById('cubetas-debe').value = Math.round((v.debe || 0) / v.precio);
  document.getElementById('monto-debe').value = v.debe || 0;
  this.currentEditSale = index;
}

editExpense(index) {
  if (index < 0 || index >= this.gastos.length) return;
  const g = this.gastos[index];
  document.getElementById('tipo-gasto').value = g.tipo;
  document.getElementById('descripcion-gasto').value = g.descripcion;
  document.getElementById('monto-gasto').value = g.monto;
  document.getElementById('fecha-gasto').value = new Date(g.fechaCompleta).toISOString().slice(0, 16);
  this.currentEditExpense = index;
}

notify(msg, type = 'success') {
  const n = document.createElement('div');
  n.innerHTML = `<div style="padding:12px 16px;border-radius:10px;color:white;font-weight:600;background:${type==='error'?'#f44336':'#4caf50'};box-shadow:0 4px 12px rgba(0,0,0,0.2);position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:10000;">${msg}</div>`;
  document.body.appendChild(n);
  setTimeout(() => {
    n.style.opacity = '0';
    n.style.transition = 'opacity 0.5s';
    setTimeout(() => n.remove(), 500);
  }, 2500);
}
}

// === INICIALIZACI√ìN ===
const businessManager = new BusinessManager();

// === PIN ===
document.addEventListener('DOMContentLoaded', () => {
const pinInput = document.getElementById('pin-input');
pinInput.addEventListener('input', () => {
  pinInput.value = pinInput.value.replace(/./g, '');
});

const pinButtons = document.querySelectorAll('.pin-btn');
pinButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const val = btn.dataset.value;
    const action = btn.dataset.action;
    if (action === 'clear') pinInput.value = '';
    else if (action === 'enter') {
      if (pinInput.value === '2007') {
        document.getElementById('pin-screen').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('pin-screen').style.display = 'none';
          document.getElementById('main-content').style.display = 'block';
          document.getElementById('main-content').style.opacity = '1';
          businessManager.notify('¬°Bienvenido!');
        }, 300);
      } else {
        businessManager.notify('PIN incorrecto', 'error');
        const c = document.querySelector('.pin-container');
        c.style.animation = 'shake 0.4s';
        setTimeout(() => c.style.animation = '', 400);
        pinInput.value = '';
      }
    } else if (val !== undefined && pinInput.value.length < 4) {
      pinInput.value += val;
    }
  });
});
});

// === EVENTOS ===
document.getElementById('agregar-venta')?.addEventListener('click', () => {
const cliente = document.getElementById('cliente')?.value.trim();
const cub = parseInt(document.getElementById('cubetas')?.value) || 0;
const prec = parseInt(document.getElementById('precio')?.value) || 0;
const fecha = document.getElementById('fecha-venta')?.value;
const cDebe = parseInt(document.getElementById('cubetas-debe')?.value) || 0;
const mDebe = parseInt(document.getElementById('monto-debe')?.value) || 0;

if (!cliente) return businessManager.notify('Cliente requerido', 'error');
if (cub <= 0) return businessManager.notify('Cubetas > 0', 'error');
if (prec <= 0) return businessManager.notify('Precio > 0', 'error');
if (!fecha) return businessManager.notify('Fecha y hora requeridas', 'error');

const total = cub * prec;
let debe = 0;
if (mDebe > 0) {
  if (mDebe > total) return businessManager.notify('Cr√©dito ‚â§ total', 'error');
  debe = mDebe;
} else if (cDebe > 0) {
  if (cDebe > cub) return businessManager.notify('Cub. cr√©dito ‚â§ vendidas', 'error');
  debe = cDebe * prec;
}

const data = {
  cliente, cubetas: cub, precio: prec, total, debe,
  fechaCompleta: new Date(fecha).toISOString()
};

if (businessManager.currentEditSale !== undefined) {
  businessManager.updateSale(businessManager.currentEditSale, data);
  businessManager.currentEditSale = undefined;
} else {
  businessManager.addSale(data);
}

// Reset
document.getElementById('cliente').value = '';
document.getElementById('cubetas').value = '1';
document.getElementById('precio').value = '5000';
document.getElementById('cubetas-debe').value = '0';
document.getElementById('monto-debe').value = '0';
document.getElementById('fecha-venta').value = new Date().toISOString().slice(0, 16);
});

document.getElementById('agregar-gasto')?.addEventListener('click', () => {
const tipo = document.getElementById('tipo-gasto')?.value;
const desc = document.getElementById('descripcion-gasto')?.value;
const monto = parseInt(document.getElementById('monto-gasto')?.value) || 0;
const fecha = document.getElementById('fecha-gasto')?.value;

if (!tipo) return businessManager.notify('Seleccione tipo', 'error');
if (!monto || monto <= 0) return businessManager.notify('Monto > 0', 'error');
if (!fecha) return businessManager.notify('Fecha y hora requeridas', 'error');

const data = { tipo, descripcion: desc, monto, fechaCompleta: new Date(fecha).toISOString() };

if (businessManager.currentEditExpense !== undefined) {
  businessManager.updateExpense(businessManager.currentEditExpense, data);
  businessManager.currentEditExpense = undefined;
} else {
  businessManager.addExpense(data);
}

// Reset
document.getElementById('descripcion-gasto').value = '';
document.getElementById('monto-gasto').value = '50000';
document.getElementById('fecha-gasto').value = new Date().toISOString().slice(0, 16);
});

document.getElementById('generar-pdf')?.addEventListener('click', () => {
if (businessManager.ventas.length === 0 && businessManager.gastos.length === 0) {
  return businessManager.notify('Sin datos para PDF', 'error');
}
const now = new Date();
document.getElementById('pdf-report-date').textContent = businessManager.formatDateTime(now.toISOString());
document.getElementById('pdf-ventas-count').textContent = businessManager.ventas.length;
document.getElementById('pdf-gastos-count').textContent = businessManager.gastos.length;
const ingr = businessManager.ventas.reduce((s, v) => s + v.total, 0);
const gast = businessManager.gastos.reduce((s, g) => s + g.monto, 0);
const neto = ingr - gast;

document.getElementById('pdf-ingresos').textContent = '$' + ingr.toLocaleString('es-CO');
document.getElementById('pdf-gastos').textContent = '$' + gast.toLocaleString('es-CO');
document.getElementById('pdf-neto').textContent = '$' + neto.toLocaleString('es-CO');
document.getElementById('pdf-total-ingresos').textContent = '$' + ingr.toLocaleString('es-CO');
document.getElementById('pdf-total-gastos').textContent = '$' + gast.toLocaleString('es-CO');
document.getElementById('pdf-balance-neto').textContent = '$' + neto.toLocaleString('es-CO');

// Ventas
const pdfSales = document.getElementById('pdf-sales-table');
if (pdfSales) {
  if (businessManager.ventas.length === 0) {
    pdfSales.innerHTML = '<tr><td colspan="6" style="text-align:center">No hay ventas</td></tr>';
  } else {
    const sorted = businessManager.sortChronological(businessManager.ventas);
    pdfSales.innerHTML = sorted.map(v => `
    <tr>
    <td>${v.cliente}</td>
    <td>${v.cubetas}</td>
    <td>$${v.precio.toLocaleString('es-CO')}</td>
    <td>$${v.total.toLocaleString('es-CO')}</td>
    <td>$${(v.debe || 0).toLocaleString('es-CO')}</td>
    <td>${businessManager.formatDateTime(v.fechaCompleta)}</td>
    </tr>
    `).join('');
  }
}

// Gastos
const pdfExpenses = document.getElementById('pdf-expenses-table');
if (pdfExpenses) {
  if (businessManager.gastos.length === 0) {
    pdfExpenses.innerHTML = '<tr><td colspan="4" style="text-align:center">No hay gastos</td></tr>';
  } else {
    const sorted = businessManager.sortChronological(businessManager.gastos);
    const labels = { purina: 'Purina', medicamento: 'Medicamento', transporte: 'Transporte', mantenimiento: 'Mant.', otros: 'Otros' };
    pdfExpenses.innerHTML = sorted.map(g => `
    <tr>
    <td>${labels[g.tipo] || g.tipo}</td>
    <td>${g.descripcion || '-'}</td>
    <td>$${g.monto.toLocaleString('es-CO')}</td>
    <td>${businessManager.formatDateTime(g.fechaCompleta)}</td>
    </tr>
    `).join('');
  }
}

// Generar PDF
const template = document.getElementById('pdf-template');
if (template) {
  template.style.display = 'block';
  html2canvas(template).then(canvas => {
    const pdf = new jsPDF('p', 'mm', 'a4');
    const w = 190;
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, w, h);
    pdf.save(`reporte-el-portachuelo-${now.toISOString().slice(0, 10)}.pdf`);
    template.style.display = 'none';
    businessManager.notify('PDF generado exitosamente');
  });
}
});

// === SINCRONIZACI√ìN (simulada, sin API real) ===
let isOnline = navigator.onLine;
const badge = document.getElementById('connection-badge');

function updateBadge() {
  badge.textContent = isOnline ? 'En l√≠nea' : 'Sin conexi√≥n';
  badge.className = 'connection-status ' + (isOnline ? 'online' : 'offline');
}

updateBadge();

window.addEventListener('online', () => {
  isOnline = true;
  updateBadge();
  businessManager.notify('üì∂ Conexi√≥n recuperada');
  // Aqu√≠ ir√≠a la l√≥gica real de sync (pero como no hay API, solo notificamos)
  setTimeout(() => {
    badge.className = 'connection-status syncing';
    badge.textContent = 'Sincronizando...';
    setTimeout(() => {
      badge.className = 'connection-status online';
      badge.textContent = 'En l√≠nea';
      businessManager.notify('‚úÖ Datos sincronizados localmente');
    }, 1500);
  }, 500);
});

window.addEventListener('offline', () => {
  isOnline = false;
  updateBadge();
  businessManager.notify('‚ö†Ô∏è Modo offline: los datos se guardar√°n localmente', 'error');
});

// === REGISTRO SERVICE WORKER ===
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('‚úÖ SW registrado:', reg.scope))
      .catch(err => console.error('‚ùå Error SW:', err));
  });
}

// === DATOS DEMO INICIALES ===
setTimeout(async () => {
  const ventas = await db.getAllVentas();
  const gastos = await db.getAllGastos();
  if (ventas.length === 0 && gastos.length === 0) {
    // Ventas demo
    await db.saveVenta({
      id: 'demo1',
      cliente: "Carnes Don Juan",
      cubetas: 10,
      precio: 5000,
      total: 50000,
      debe: 0,
      fechaCompleta: new Date(2025, 11, 28, 9, 30).toISOString()
    });
    await db.saveVenta({
      id: 'demo2',
      cliente: "Restaurante El Sabor",
      cubetas: 5,
      precio: 5200,
      total: 26000,
      debe: 10000,
      fechaCompleta: new Date(2025, 11, 29, 14, 15).toISOString()
    });
    // Gastos demo
    await db.saveGasto({
      id: 'demo3',
      tipo: "purina",
      descripcion: "Bulto 40kg",
      monto: 85000,
      fechaCompleta: new Date(2025, 11, 27, 11, 20).toISOString()
    });
    await db.saveGasto({
      id: 'demo4',
      tipo: "medicamento",
      descripcion: "Vitamina AD3E",
      monto: 32000,
      fechaCompleta: new Date(2025, 11, 28, 16, 45).toISOString()
    });
    businessManager.loadData();
  }
}, 300);
</script>
</body>
</html>